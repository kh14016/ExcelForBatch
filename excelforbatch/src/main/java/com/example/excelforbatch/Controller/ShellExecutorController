package com.example.excelforbatch.Controller;

import com.excelshell.service.ShellExecutorService;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.*;
import org.springframework.web.multipart.MultipartFile;

import java.util.List;

@Controller
@RequiredArgsConstructor
public class ShellExecutorController {

    private final ShellExecutorService shellExecutorService;

    @GetMapping("/")
    public String index() {
        return "index";
    }

    @PostMapping("/upload")
    @ResponseBody
    public List<String> uploadFile(@RequestParam("file") MultipartFile file) {
        try {
            return shellExecutorService.getColumnList(file);
        } catch (Exception e) {
            throw new RuntimeException("Failed to read Excel file: " + e.getMessage());
        }
    }

    @PostMapping("/execute")
    public String executeCommands(
            @RequestParam("file") MultipartFile file,
            @RequestParam("columnIndex") int columnIndex,
            @RequestParam("waitTime") int waitTime,
            Model model) {
        try {
            var results = shellExecutorService.executeCommands(file, columnIndex, waitTime);
            model.addAttribute("results", results);
            return "result";
        } catch (Exception e) {
            model.addAttribute("error", "Execution failed: " + e.getMessage());
            return "error";
        }
    }
}